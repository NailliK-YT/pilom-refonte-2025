const BASE_URL=window.location.origin+"/";function initLogoUpload(){const e=document.getElementById("logoUpload"),t=(document.getElementById("logoPreview"),document.getElementById("deleteLogo")),o=document.querySelector(".logo-preview");e&&e.addEventListener("change",function(e){const t=e.target.files[0];if(!t)return;if(!t.type.match("image.*"))return void showMessage("Veuillez sélectionner une image valide.","danger");if(t.size>5242880)return void showMessage("La taille de l'image ne doit pas dépasser 5MB.","danger");const n=new FileReader;n.onload=function(e){o&&(o.style.opacity="0.5",o.style.transition="opacity 0.3s ease"),setTimeout(()=>{const t=o.querySelector("img"),n=o.querySelector(".logo-placeholder");if(t)t.src=e.target.result;else if(n){const t=document.createElement("img");t.src=e.target.result,t.alt="Logo de l'entreprise",t.id="logoPreview",n.replaceWith(t)}o.style.opacity="1"},300)},n.readAsDataURL(t)}),t&&t.addEventListener("click",function(){confirm("❌ Voulez-vous vraiment supprimer le logo ?")&&(this.classList.add("loading"),this.disabled=!0,fetch(BASE_URL+"settings/company/delete-logo",{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>e.json()).then(e=>{e.success?(showMessage("✓ Logo supprimé avec succès !","success"),setTimeout(()=>location.reload(),1e3)):(this.classList.remove("loading"),this.disabled=!1,showMessage(e.error||"Erreur lors de la suppression.","danger"))}).catch(e=>{console.error("Error:",e),this.classList.remove("loading"),this.disabled=!1,showMessage("Erreur de connexion.","danger")}))})}function uploadLogo(e){const t=new FormData;t.append("logo",e),fetch(BASE_URL+"settings/company/upload-logo",{method:"POST",body:t,headers:{"X-Requested-With":"XMLHttpRequest"}}).then(e=>e.json()).then(e=>{e.success?(showMessage("Logo mis à jour avec succès !","success"),setTimeout(()=>location.reload(),1e3)):alert(e.error||"Erreur lors du téléchargement.")}).catch(e=>{console.error("Error:",e),alert("Erreur de connexion.")})}function initInvoicePreview(){const e=document.getElementById("invoice_prefix"),t=document.getElementById("invoice_next_number"),o=document.getElementById("invoicePreview");if(e&&t&&o){const n=()=>{const n=e.value||"INV",i=t.value||"1",s=String(i).padStart(4,"0");o.textContent=`${n}-${s}`};e.addEventListener("input",n),t.addEventListener("input",n)}}function initSettingsValidation(){const e=document.getElementById("siret");e&&e.addEventListener("input",function(){this.value=this.value.replace(/\D/g,""),14===this.value.length?validateSiret(this.value)?this.style.borderColor="#16a34a":this.style.borderColor="#dc2626":this.style.borderColor="#ddd"});const t=document.getElementById("iban");t&&(t.addEventListener("input",function(){this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,"")}),t.addEventListener("blur",function(){this.value&&(this.value=this.value.match(/.{1,4}/g).join(" "))}));const o=document.getElementById("bic");o&&o.addEventListener("input",function(){this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,"")})}function validateSiret(e){if(14!==e.length||!/^\d+$/.test(e))return!1;let t=0;for(let o=0;o<14;o++){let n=parseInt(e[o]);o%2==1&&(n*=2,n>9&&(n-=9)),t+=n}return t%10==0}function showMessage(e,t="info"){const o=document.createElement("div");o.className=`alert alert-${t}`,o.textContent=e;const n=document.querySelector(".settings-content");n&&(n.insertBefore(o,n.firstChild),setTimeout(()=>o.remove(),5e3))}document.addEventListener("DOMContentLoaded",function(){initLogoUpload(),initInvoicePreview(),initSettingsValidation()});